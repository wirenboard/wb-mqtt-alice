#!/bin/bash
# filepath: debian/postinst

set -e

# Paths
NEW_CONF="/etc/wb-mqtt-alice-client.conf"
MIGRATION_FLAG="/var/lib/wb-mqtt-alice-migration-flag"

# Function to update client_enabled in JSON config while preserving other fields
set_client_enabled() {
    local conf_file="$1"
    local value="$2"
    python3 -c "
import json
# Read existing config (with all fields)
try:
    with open('$conf_file', 'r') as f:
        config = json.load(f)
except FileNotFoundError:
    config = {}
# Update ONLY client_enabled field
config['client_enabled'] = ('$value' == 'True')
# Write back with all fields preserved
with open('$conf_file', 'w') as f:
    json.dump(config, f, indent=2)
"
}

case "$1" in
    configure)
        # Apply migration if flag file exists
        if [ -f "$MIGRATION_FLAG" ]; then
            VALUE=$(cat "$MIGRATION_FLAG")
            echo "[postinst] Migration flag found, value: $VALUE"
            echo "[postinst] File before migration:"
            cat "$NEW_CONF" || echo "[postinst] File does not exist!"
            
            set_client_enabled "$NEW_CONF" "$VALUE"
            
            echo "[postinst] File after migration:"
            cat "$NEW_CONF"
            
            # Clean up migration flag
            rm -f "$MIGRATION_FLAG"
        else
            echo "[postinst] No migration flag found, skipping migration"
        fi
        ;;
    abort-upgrade|abort-remove|abort-deconfigure)
        ;;
    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

#DEBHELPER#

exit 0
