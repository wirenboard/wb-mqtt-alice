#!/bin/bash
# postrm script for wb-mqtt-alice
# This script is called after package removal to cleanup

set -e

CONFFILE_DEVICES='/etc/wb-mqtt-alice-devices.conf'
CONFFILE_DEVICES_DEFAULT='/etc/wb-mqtt-alice-devices.conf.default'
MENU_FILE="/usr/share/wb-mqtt-homeui/custom-menu/alice-menu-item.json"

PACKET_NAME='wb-mqtt-alice'
SITE_NAME="${PACKET_NAME}-proxy"
SITE_CONFIG="/etc/nginx/sites-available/${SITE_NAME}"
ENABLED_SITE="/etc/nginx/sites-enabled/${SITE_NAME}"

# Global flag to track if any changes were made
CHANGES_MADE='false'

LOG_PREFIX="[${PACKET_NAME} cleanup]"

log_info() {
    echo "${LOG_PREFIX} ${1}"
}

log_warn() {
    echo "${LOG_PREFIX} WARNING: ${1}" >&2
}

cleanup_nginx_site() {
    log_info "Cleaning up nginx site configuration..."
    
    # Remove enabled site symlink
    if [[ -L "${ENABLED_SITE}" ]]; then
        rm -f "${ENABLED_SITE}"
        log_info "Removed nginx site symlink: ${ENABLED_SITE}"
        CHANGES_MADE='true'
    fi
    
    # Remove site configuration
    if [[ -f "${SITE_CONFIG}" ]]; then
        rm -f "${SITE_CONFIG}"
        log_info "Removed nginx site config: ${SITE_CONFIG}"
        CHANGES_MADE='true'
    fi
}

reload_nginx() {
    log_info "Checking nginx configuration..."

    if ! nginx -t >/dev/null 2>&1; then
        log_warn "nginx configuration test failed, skipping reload"
        return 1
    fi

    if deb-systemd-invoke is-active nginx >/dev/null 2>&1; then
        deb-systemd-invoke reload nginx
        log_info "nginx reloaded"
    else
        log_info "nginx not running, skipping reload"
    fi
}

main() {
    log_info "Removing wb-mqtt-alice configuration..."

    if [ "${1}" = "purge" ]; then
        rm -f ${CONFFILE_DEVICES}
        log_info "Removed devices config: ${CONFFILE_DEVICES}"
        rm -f ${CONFFILE_DEVICES_DEFAULT}
        log_info "Removed default devices config: ${CONFFILE_DEVICES_DEFAULT}"
    fi

    # Note: we NOT remove SSL directive "ssl_engine ateccx08;" from nginx.conf
    # We can't guarantee they were added by us or not used elsewhere
    cleanup_nginx_site

    # Delete the menu item file for the web interface
    if [ -f "${MENU_FILE}" ] || [ -L "${MENU_FILE}" ]; then
        rm -f "${MENU_FILE}"
        log_info "Removed web interface menu item: ${MENU_FILE}"
    fi
    
    # Only reload nginx if any changes were made
    if [ "${CHANGES_MADE}" = 'true' ]; then
        log_info "Changes were made, reloading nginx..."
        reload_nginx
    else
        log_info "No changes made, nginx reload skipped"
    fi
   
    log_info "Cleanup completed successfully"
}

main "${@}"

#DEBHELPER#
