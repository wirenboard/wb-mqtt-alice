# Клиент для интеграции контроллера Wiren Board с умным домом Яндекса

[Ссылка на официальную документацию](https://wiki.wirenboard.com/wiki/Yandex-smart-home)

**Интеграция работает только при использовании русского языка в веб‑интерфейсе контроллера.**

Клиент активируется только при добавлении через webui конфигуратор хотя бы одного устройства, иначе клиент не активен.
 - При старте читает статус активации из конфигурационного файла JSON и запускается только если клиент уже активирован (в конфиг файле
  `client_enabled` установлено как `true`)
- Берет адрес сервера из конфигурационного файла (server_domain)
- Считывает серийный номер контроллера из файла `/var/lib/wirenboard/short_sn.conf`


## Кратко о назначении клиента:

- `wb-mqtt-alice-config` — конфигуратор устройств.
- `wb-mqtt-alice-client` — сервис, обеспечивающий работу интеграции.
- `wb-mqtt-alice` — CLI-утилита для управления.

## Установка пакета на контроллер

Перейдите в [_testing_](https://wiki.wirenboard.com/wiki/Testing).

Если пакет не установился на контроллере после обновления, попробуйте выполнить:

```terminal
apt update && apt full-upgrade
```

## Добавление интеграции в Яндексе

- В приложении «Дом» с Алисой нажмите в правом верхнем углу «+» и выберите «Устройство умного дома».
- В поле поиска найдите навык «Wiren Board» и выберите его.
- Обновите список устройств.

## Удаление интеграции

Если интеграция с Алисой не нужна, её можно удалить:

1. Отвяжите контроллер. На странице привязанных контроллеров нажмите на красный крестик рядом с нужным контроллером.
2. Удалите пакет:

```terminal
apt purge wb-mqtt-alice
```
3. Запретите автоматическую установку при обновлении:

```terminal
apt-mark hold wb-mqtt-alice
```

Если интеграцию потребуется восстановить, снимите блокировку и установите пакет:

```terminal
apt-mark unhold wb-mqtt-alice
apt install wb-mqtt-alice
```

## Отвязка контроллера

Если невозможно отвязать контроллер со страницы привязанных контроллеров (например, был утрачен доступ к учётной записи Яндекса), можно воспользоваться утилитой `wb-mqtt-alice`:

```terminal
wb-mqtt-alice unlink-controller
```

Чтобы узнать статус привязки контроллера, можно воспользоваться командой:

```terminal
wb-mqtt-alice get-link-status
```

## Просмотр логов сервиса:

- Для просмотра логов сервиса:
```terminal
journalctl -u wb-mqtt-alice-client -f
```
- Для просмотров логов CLI утилиты:
```terminal
journalctl -t wb-mqtt-alice-cli -f
```

## Веб-интерфейс
Для отображения/скрытия пункта меню "Яндекс Алиса" небходим конфигурационный файл alice-navigation.json, который устанавливается в папку "/usr/share/wb-mqtt-homeui/custom-menu".
Это необходимо для дальнейшей реализации механизма отображения/скрытия пунктов меню в homeui.
